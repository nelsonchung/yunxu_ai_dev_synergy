# 系統架構說明

## 1. 系統目標與範圍
本系統為「義麵房」冷凍義大利麵品牌官網，提供品牌展示、菜單與訂購資訊，以及「客服對話」功能（訪客與客服後台即時溝通）。

## 2. 高階架構
```
[Browser SPA]
  |  React + Vite + Wouter + Tailwind
  |  tRPC client (HTTP batch, credentials include)
  v
[Express Server]
  | /api/trpc     -> tRPC router (auth, customerService, system)
  | /api/oauth/*  -> OAuth callback
  | static files  -> dist/public (production)
  v
[MySQL]
  | users, conversations, messages (Drizzle ORM)

[External Services]
  - Manus OAuth Server (OAUTH_SERVER_URL)
  - Forge APIs (BUILT_IN_FORGE_API_URL/KEY)
    * notification / data API / LLM / image / storage
  - Google Maps (frontend via Forge proxy)
```

## 3. 主要元件與責任
### 3.1 前端（client）
- React 19 + Vite 組成 SPA。
- 路由：wouter。
- UI：Tailwind + Radix UI + shadcn/ui。
- 客服 Widget：`client/src/components/CustomerServiceWidget.tsx`。
- 客服後台：`/admin/login`、`/admin/customer-service`。

### 3.2 後端（server）
- Express + tRPC 作為 API 層。
- 開發模式：Vite middleware。
- 正式模式：Serve 靜態檔案與 API。
- OAuth：`/api/oauth/callback` 交換 token、建立 session cookie。

### 3.3 資料庫（drizzle + MySQL）
- `users`：OAuth 使用者與角色。
- `conversations`：客服對話會話。
- `messages`：客服訊息。

### 3.4 外部整合
- OAuth Server：提供登入與使用者資訊。
- Forge API：通知、LLM、影像、語音、地圖等。
- Google Maps：前端透過 Forge proxy 取得地圖腳本。

## 4. 主要流程
### 4.1 訪客客服對話（輪詢）
1. 前端產生 visitorId（localStorage）。
2. 呼叫 `customerService.getOrCreateConversation`。
3. 訪客與客服訊息透過 `sendVisitorMessage` / `sendAdminMessage` 傳送。
4. 訊息更新使用輪詢：訪客端 3 秒、客服端 3 秒。

### 4.2 客服後台登入
1. `/admin/login` 送出帳號密碼到 `csAdmin.login`。
2. 後端驗證環境變數帳密並寫入 httpOnly cookie。
3. 後台頁面使用 `csAdmin.me` 驗證登入狀態。

## 5. 部署模式
- 開發：`pnpm dev`（Express + Vite middleware）
- 建置：`pnpm build`（Vite => dist/public，Server => dist/index.js）
- 上線：`pnpm start`（Express serve dist/public + API）