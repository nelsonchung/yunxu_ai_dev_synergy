# 系統驗證（System Verification）

## 1. 驗證目標
確保核心功能（網站瀏覽、客服對話、後台管理、OAuth 登入）在不同環境下可穩定運作，並符合基本安全與資料一致性需求。

## 2. 自動化測試
### 2.1 單元/路由測試（Vitest）
- `server/customerService.test.ts`
  - 驗證客服會話與訊息流程。
  - 檢查訪客/客服權限與未讀標記更新。
- `server/csAdminAuth.test.ts`
  - 驗證客服後台登入/登出行為。
- `server/auth.logout.test.ts`
  - 驗證一般使用者登出行為與 cookie 清除。

### 2.2 型別檢查
- `pnpm check`：TypeScript 靜態檢查。

## 3. 手動測試建議
### 3.1 公開頁面
1. 逐頁瀏覽首頁、菜單、關於我們、訂購資訊、聯絡我們。
2. 檢查 RWD 版面在手機/桌面是否正常。

### 3.2 客服 Widget（訪客）
1. 開啟客服 Widget。
2. 送出訊息並確認訊息顯示在對話列表。
3. 關閉/重開視窗，確認歷史訊息仍存在（localStorage visitorId）。

### 3.3 客服後台
1. 進入 `/admin/login`，登入後台。
2. 在後台查看對話列表與未讀標記。
3. 選擇對話後回覆訊息。
4. 點擊「結束對話」後確認狀態為已結束。

### 3.4 OAuth 流程
1. 觸發 OAuth 登入。
2. 回到網站後確認 cookie 已寫入，刷新仍保持登入。

## 4. 佈署驗證
1. `pnpm build` 產出 `dist/public` 與 `dist/index.js`。
2. `pnpm start` 後確認：
   - `GET /` 能正確載入 SPA。
   - `/api/trpc` 正常回應。

## 5. 資料一致性檢查
- Conversations 與 Messages 關聯是否正確。
- 未讀標記（hasUnreadFromVisitor / hasUnreadFromAdmin）是否正確更新。

## 6. 回歸檢查清單
- 新增訊息後是否立即顯示。
- 會話列表更新是否正常（5 秒輪詢）。
- 斷線或重新整理後，會話與訊息是否仍可正確載入。