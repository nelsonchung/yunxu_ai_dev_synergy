# 軟體設計（Software Design）

## 1. 專案結構
```
client/      前端 SPA（React + Vite）
server/      後端 API（Express + tRPC）
shared/      前後端共用型別/常數
drizzle/     DB schema 與 migrations
```

## 2. 前端設計
### 2.1 路由
- 使用 `wouter`。
- 公開頁面：`/`、`/menu`、`/about`、`/order-info`、`/contact`。
- 後台頁面：`/admin/login`、`/admin/customer-service`。

### 2.2 tRPC Client
- `client/src/main.tsx` 內建立 tRPC client。
- 使用 `httpBatchLink`，並設定 `credentials: "include"`，確保 cookie 送出。
- 透過 Query/Mutation Cache 全局攔截未授權錯誤（UNAUTHED_ERR_MSG）。

### 2.3 客服 Widget
- `CustomerServiceWidget.tsx`：右下角浮動視窗。
- 訪客 ID 使用 localStorage + nanoid。
- 對話/訊息輪詢：3 秒。

### 2.4 客服後台
- `AdminLogin.tsx`：輸入帳號密碼登入。
- `AdminCustomerService.tsx`：對話列表、詳細訊息、結束對話。
- 輪詢：對話列表 5 秒，訊息內容 3 秒。

## 3. 後端設計
### 3.1 tRPC Router 結構
- `system`：
  - `health`：健康檢查
  - `notifyOwner`：通知 Owner（需 admin 權限）
- `auth`：
  - `me`：讀取使用者
  - `logout`：清除 session cookie
- `csAdmin`：
  - `login` / `logout` / `me`
- `customerService`：
  - 訪客端：`getOrCreateConversation`, `getConversationByVisitorId`, `getVisitorMessages`, `sendVisitorMessage`, `checkUnreadFromAdmin`
  - 客服端：`getAllConversations`, `getConversationDetails`, `sendAdminMessage`, `closeConversation`

### 3.2 Context 與授權
- `createContext` 會嘗試 OAuth session 驗證（`sdk.authenticateRequest`）。
- 客服後台為獨立驗證（cookie `cs_admin_session`）。
- `csAdminProcedure` 會檢查 `ctx.isCsAdmin`。

### 3.3 OAuth 流程
- 前端產生 OAuth login URL。
- OAuth callback：`/api/oauth/callback` 交換 token、寫入 session cookie。
- Session 使用 JWT (HS256)，`JWT_SECRET` 為 key。

## 4. 資料模型
### 4.1 users
- openId（OAuth 唯一 ID）
- name / email / loginMethod
- role（user / admin）

### 4.2 conversations
- visitorId（匿名訪客 ID）
- visitorName / visitorEmail
- status（active / closed）
- hasUnreadFromVisitor / hasUnreadFromAdmin

### 4.3 messages
- conversationId
- senderType（visitor / admin）
- content

## 5. 訊息流程
### 5.1 訪客 -> 客服
1. 前端建立會話 `getOrCreateConversation`。
2. 訪客送出訊息 `sendVisitorMessage`。
3. 後端寫入 messages，並更新 conversations 未讀標記。
4. 客服端輪詢 `getConversationDetails` 取得新訊息。

### 5.2 客服 -> 訪客
1. 後台發送訊息 `sendAdminMessage`。
2. 伺服器寫入 messages，更新未讀標記。
3. 訪客端輪詢 `getVisitorMessages` 取得新訊息。

## 6. 非功能設計重點
- 訊息長度限制：2000 字。
- 輪詢降低實作成本（可替換為 WebSocket/SSE）。
- 使用 superjson 支援 Date 物件序列化。

## 狀態
客戶需要調整部分內容